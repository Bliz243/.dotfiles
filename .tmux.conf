# ─────────────────────────────────────────────
# Core settings
# ─────────────────────────────────────────────
set -g default-terminal "tmux-256color"
set -sa terminal-overrides ",xterm*:Tc"
set -g mouse on

# ─────────────────────────────────────────────
# Prefix key (configurable per machine)
# ─────────────────────────────────────────────
# Set TMUX_PREFIX in ~/.zsh/99-local.zsh:
#   - Local (WSL):  export TMUX_PREFIX="C-a"  (default)
#   - Remote (VPS): export TMUX_PREFIX="C-b"
#
# Default: C-a
unbind C-b
unbind C-a
set -g prefix C-a
bind C-a send-prefix

# Override prefix if TMUX_PREFIX is set to C-b
if-shell '[ "$TMUX_PREFIX" = "C-b" ]' {
  set -g prefix C-b
  bind C-b send-prefix
}

# Windows/panes start at 1
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on

# Sensible defaults
set -s escape-time 0
set -g history-limit 50000
set -g display-time 4000
set -g status-interval 5

# Extended keys and passthrough (tmux 3.3+ only)
if-shell '[ "$(tmux -V | cut -d" " -f2 | tr -d "a-z")" \> "3.2" ]' {
  set -s extended-keys always
  set -as terminal-features 'xterm*:extkeys'
  set -g allow-passthrough on
}

# ─────────────────────────────────────────────
# Pane navigation (vim-style)
# ─────────────────────────────────────────────
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Alt-arrow without prefix
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# ─────────────────────────────────────────────
# Window navigation
# ─────────────────────────────────────────────
bind -n S-Left previous-window
bind -n S-Right next-window
bind -n M-H previous-window
bind -n M-L next-window

# ─────────────────────────────────────────────
# Splits (keep current path)
# ─────────────────────────────────────────────
bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# ─────────────────────────────────────────────
# Copy mode (vi) and mouse selection
# ─────────────────────────────────────────────
set-window-option -g mode-keys vi
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Mouse selection copies to clipboard
set -g @yank_selection_mouse 'clipboard'

# Double-click to select word, triple-click to select line
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send-keys -X select-word
bind -T copy-mode-vi TripleClick1Pane select-pane \; send-keys -X select-line
bind -n DoubleClick1Pane select-pane -t = \; if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" { send-keys -M } { copy-mode -H ; send-keys -X select-word }
bind -n TripleClick1Pane select-pane -t = \; if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" { send-keys -M } { copy-mode -H ; send-keys -X select-line }

# Drag to select (auto-copies on release via tmux-yank)
bind -n MouseDrag1Pane if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" { send-keys -M } { copy-mode -H }

# Shift+click bypasses tmux (native terminal selection)
bind -T root S-MouseDown1Pane send-keys -M
bind -T root S-MouseDrag1Pane send-keys -M
bind -T root S-MouseDown3Pane send-keys -M

# ─────────────────────────────────────────────
# Utilities
# ─────────────────────────────────────────────
bind R source-file ~/.tmux.conf \; display "Config reloaded!"
bind x kill-pane

# ─────────────────────────────────────────────
# Plugins
# ─────────────────────────────────────────────
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'catppuccin/tmux#v2.1.3'

# ─────────────────────────────────────────────
# Catppuccin Theme (color changes based on machine)
# ─────────────────────────────────────────────
# Default: mocha (dark purple-ish) for local
set -g @catppuccin_flavor 'mocha'

# Remote/VPS: macchiato (slightly different tone) - visual indicator
if-shell '[ "$TMUX_PREFIX" = "C-b" ]' {
  set -g @catppuccin_flavor 'macchiato'
}

# ─────────────────────────────────────────────
# Window naming
# ─────────────────────────────────────────────
# Pane titles are set by zsh preexec/precmd hooks
set -g set-titles on
set -g allow-rename on

# Window styling
set -g @catppuccin_window_status_style 'rounded'
set -g @catppuccin_window_number_position 'left'
set -g @catppuccin_window_default_fill 'number'
set -g @catppuccin_window_current_fill 'number'

# Show pane title (set by zsh to current command)
set -g @catppuccin_window_default_text '#T'
set -g @catppuccin_window_current_text '#T'

# Status bar position
set -g status-position bottom
set -g status-justify left

# Status left: session name
set -g status-left-length 100
set -g status-left "#{E:@catppuccin_status_session} "

# Status right: directory only
set -g status-right-length 100
set -g @catppuccin_directory_text "#{s|$HOME|~|:pane_current_path}"
set -g status-right "#{E:@catppuccin_status_directory}"

# Initialize TPM (keep at bottom)
run '~/.tmux/plugins/tpm/tpm'
