---
- name: Install common packages
  become: yes
  vars:
    common_packages:
      # Essential tools
      - git
      - curl
      - wget
      - tree
      - htop
      - tmux
      - neovim
      - fontconfig
      - unzip
      - zip
      - stow       # GNU Stow for dotfiles management
      # Modern CLI tools (may not be available in all repos)
      - eza        # Modern ls replacement (fallback to exa or ls)
      - bat        # Better cat
      - fd-find    # Better find
      - ripgrep    # Better grep
      - fzf        # Fuzzy finder
      - zoxide     # Smart cd
      # Terminal
      - alacritty
  block:
    - name: Update package manager cache
      package:
        update_cache: yes
      ignore_errors: yes

    - name: Install common packages individually
      package:
        name: "{{ item }}"
        state: present
      loop: "{{ common_packages }}"
      ignore_errors: yes
      register: package_install_results
      loop_control:
        label: "{{ item }}"

    - name: Report failed package installations
      debug:
        msg: "Failed to install packages: {{ package_install_results.results | selectattr('failed', 'equalto', true) | map(attribute='item') | list }}"
      when: package_install_results is defined and package_install_results.results | selectattr('failed', 'equalto', true) | list | length > 0

# Install modern tools via cargo if not available in package manager
- name: Check if cargo is available
  command: which cargo
  register: cargo_check
  ignore_errors: yes
  changed_when: false

- name: Install modern CLI tools via cargo (if not in package manager)
  block:
    - name: Check if eza is installed
      command: which eza
      register: eza_check
      ignore_errors: yes
      changed_when: false

    - name: Check if exa is installed (fallback)
      command: which exa
      register: exa_check
      ignore_errors: yes
      changed_when: false

    - name: Install eza via cargo
      command: cargo install eza
      when: eza_check.rc != 0 and exa_check.rc != 0
      ignore_errors: yes
      become: no

    - name: Check if bat is installed
      command: which bat
      register: bat_check
      ignore_errors: yes
      changed_when: false

    - name: Check if batcat is installed (Ubuntu/Debian)
      command: which batcat
      register: batcat_check
      ignore_errors: yes
      changed_when: false

    - name: Install bat via cargo
      command: cargo install bat
      when: bat_check.rc != 0 and batcat_check.rc != 0
      ignore_errors: yes
      become: no

    - name: Check if fd is installed
      command: which fd
      register: fd_check
      ignore_errors: yes
      changed_when: false

    - name: Install fd via cargo
      command: cargo install fd-find
      when: fd_check.rc != 0
      ignore_errors: yes
      become: no

    - name: Check if ripgrep is installed
      command: which rg
      register: rg_check
      ignore_errors: yes
      changed_when: false

    - name: Install ripgrep via cargo
      command: cargo install ripgrep
      when: rg_check.rc != 0
      ignore_errors: yes
      become: no

    - name: Check if zoxide is installed
      command: which zoxide
      register: zoxide_check
      ignore_errors: yes
      changed_when: false

    - name: Install zoxide via cargo
      command: cargo install zoxide
      when: zoxide_check.rc != 0
      ignore_errors: yes
      become: no
  when: cargo_check.rc == 0
